<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>YADEA Sales Portal V14 (Mobile Optimized)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { font-family: 'Roboto', sans-serif; background-color: #F8FAFC; }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    
    .nav-item { display: flex; align-items: center; padding: 12px 20px; color: #9ca3af; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
    .nav-item:hover { background-color: #1f2937; color: white; }
    .nav-item.active { background-color: #1f2937; color: #fff; border-left-color: #FF4500; }
    .nav-item i { width: 20px; margin-right: 10px; text-align: center; }
    
    .form-label { font-size: 11px; font-weight: 800; text-transform: uppercase; color: #6b7280; margin-bottom: 6px; display: block; letter-spacing: 0.5px; }
    
    /* MOBILE OPTIMIZATION: TƒÉng size font v√† padding ƒë·ªÉ d·ªÖ b·∫•m tr√™n ƒëi·ªán tho·∫°i */
    .form-input { width: 100%; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 12px; font-weight: 600; font-size: 16px; color: #1e293b; transition: 0.2s; outline: none; }
    .form-input:focus { border-color: #FF4500; box-shadow: 0 0 0 3px rgba(255,69,0,0.1); }
    .form-input[readonly] { background-color: #f3f4f6; color: #64748b; cursor: not-allowed; }
    .form-input:disabled { background-color: #f3f4f6; cursor: not-allowed; opacity: 0.7; }
    
    .edit-mode-banner { background: #fff7ed; border: 1px solid #fdba74; color: #c2410c; padding: 12px; border-radius: 8px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(253, 186, 116, 0.2); }
  </style>
</head>
<body class="h-screen overflow-hidden flex text-slate-800">

  <div id="authContainer" class="fixed inset-0 z-[60] bg-[#F3F4F6] flex items-center justify-center p-4">
    <div class="bg-white rounded-[20px] shadow-2xl overflow-hidden flex flex-col md:flex-row max-w-4xl w-full min-h-[550px] fade-in">
      <div class="w-full md:w-5/12 bg-[#111827] flex flex-col items-center justify-center p-10 text-center relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-br from-orange-600/20 to-blue-600/20"></div>
        <img src="https://raw.githubusercontent.com/vuhuythanh/tichdiem/refs/heads/main/logo%20YADEA.png" class="h-12 brightness-0 invert mb-6 relative z-10">
        <h2 class="text-2xl font-black text-white uppercase mb-2 relative z-10">C·ªîNG NH√ÇN VI√äN V14</h2>
        <p class="text-gray-400 text-xs font-medium relative z-10">Sales & Operations Portal</p>
      </div>
      <div class="w-full md:w-7/12 p-10 flex flex-col justify-center">
        <div id="loginFormSection" class="max-w-xs mx-auto w-full">
          <h3 class="text-2xl font-black text-slate-800 mb-6">ƒêƒÉng Nh·∫≠p</h3>
          <div class="space-y-4">
            <input id="email" type="email" class="form-input bg-gray-50" placeholder="Email nh√¢n vi√™n">
            <input id="password" type="password" class="form-input bg-gray-50" placeholder="M·∫≠t kh·∫©u">
            <button id="btnLogin" class="w-full bg-[#FF4500] hover:bg-orange-600 text-white font-bold py-3.5 rounded-xl transition shadow-lg text-sm uppercase tracking-wider">Truy c·∫≠p</button>
          </div>
          <div class="mt-6 text-center text-xs text-gray-400">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" id="goSignup" class="text-[#FF4500] font-bold hover:underline">ƒêƒÉng k√Ω ngay</a></div>
        </div>
        <div id="signupFormSection" class="hidden max-w-xs mx-auto w-full">
            <h3 class="text-2xl font-black text-slate-800 mb-4">ƒêƒÉng K√Ω M·ªõi</h3>
            <div class="space-y-3">
                <input id="reg_name" type="text" class="form-input bg-gray-50" placeholder="H·ªç v√† T√™n (ƒê√∫ng chu·∫©n)">
                <p class="text-[9px] text-gray-400 italic mb-1">* Nh·∫≠p ƒë√∫ng t√™n ƒë·ªÉ h·ªá th·ªëng t·ª± g√°n Shop.</p>
                <select id="reg_role" class="form-input bg-gray-50"><option value="Sale">Nh√¢n vi√™n Sale</option><option value="Gi√°m ƒê·ªëc">Gi√°m ƒê·ªëc Mi·ªÅn</option></select>
                <input id="reg_email" type="email" class="form-input bg-gray-50" placeholder="Email">
                <input id="reg_pass" type="password" class="form-input bg-gray-50" placeholder="M·∫≠t kh·∫©u">
                <button id="btnSignup" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl">G·ª≠i Y√™u C·∫ßu</button>
            </div>
            <div class="mt-4 text-center text-xs"><a href="#" id="goLogin" class="text-gray-500 font-bold">‚Üê Quay l·∫°i ƒëƒÉng nh·∫≠p</a></div>
        </div>
        <p id="msg" class="text-center text-xs font-bold mt-4 h-5 text-red-500"></p>
      </div>
    </div>
  </div>

  <div id="mainApp" class="hidden flex w-full h-full relative">
    
    <div class="md:hidden fixed top-0 left-0 w-full h-14 bg-[#111827] z-40 flex items-center px-4 shadow-md justify-between">
        <div class="flex items-center gap-2">
            <img src="https://raw.githubusercontent.com/vuhuythanh/tichdiem/refs/heads/main/logo%20YADEA.png" class="h-6 brightness-0 invert">
            <span class="text-white font-bold text-xs uppercase tracking-wide">Sales Portal</span>
        </div>
        <button onclick="toggleSidebar()" class="text-white text-2xl focus:outline-none p-2">
            <i class="fa-solid fa-bars"></i>
        </button>
    </div>

    <aside id="sidebarMobile" class="fixed inset-y-0 left-0 w-64 bg-[#111827] flex-shrink-0 flex flex-col border-r border-gray-800 z-50 shadow-xl transition-transform duration-300 transform -translate-x-full md:relative md:translate-x-0 pt-14 md:pt-0">
        
        <div class="md:hidden absolute top-3 right-3">
             <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white p-2">
                <i class="fa-solid fa-xmark text-xl"></i>
             </button>
        </div>

        <div class="hidden md:flex h-16 items-center px-6 border-b border-gray-800 bg-[#1f2937]">
            <img src="https://raw.githubusercontent.com/vuhuythanh/tichdiem/refs/heads/main/logo%20YADEA.png" class="h-6 brightness-0 invert">
        </div>
        
        <div class="p-6 border-b border-gray-800">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-orange-600 flex items-center justify-center text-white font-bold text-sm shadow-lg" id="avatarLetter">U</div>
                <div class="overflow-hidden">
                    <h4 id="userDisplay" class="text-white text-sm font-bold truncate">User</h4>
                    <span id="roleDisplay" class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">SALE</span>
                </div>
            </div>
        </div>
  
        <nav class="flex-1 py-6 space-y-1">
            <a onclick="switchView('sales')" id="nav-sales" class="nav-item active"><i class="fa-solid fa-boxes-stacked text-orange-500"></i> 1. Kho & Doanh Thu</a>
            <a onclick="switchView('costs')" id="nav-costs" class="nav-item"><i class="fa-solid fa-file-invoice-dollar text-blue-500"></i> 2. Nh·∫≠p Chi Ph√≠ (P&L)</a>
            <a onclick="switchView('history')" id="nav-history" class="nav-item"><i class="fa-solid fa-clock-rotate-left text-purple-500"></i> 3. L·ªãch s·ª≠ & S·ª≠a</a>
            <a onclick="switchView('charts')" id="nav-charts" class="nav-item"><i class="fa-solid fa-chart-line text-green-500"></i> 4. Ph√¢n T√≠ch Chi·∫øn L∆∞·ª£c</a>
        </nav>
        
        <div class="p-4 bg-[#0f1523] border-t border-gray-800">
            <button id="btnLogout" class="flex items-center justify-center w-full py-2.5 text-xs font-bold text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg transition border border-gray-700"><i class="fa-solid fa-right-from-bracket mr-2"></i> ƒêƒÉng xu·∫•t</button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-[#F8FAFC] relative pt-14 md:pt-0">
        <form id="financeForm"> 
            
            <div id="view-sales" class="p-4 md:p-8 fade-in max-w-[1600px] mx-auto">
                <div class="flex justify-between items-end mb-6">
                    <div><h1 id="entryTitle" class="text-xl md:text-2xl font-black text-slate-800 uppercase">1. B√°o C√°o Nh·∫≠p - Xu·∫•t</h1><p class="text-gray-500 text-xs mt-1">B∆∞·ªõc 1: Khai b√°o ƒë·ªãa ƒëi·ªÉm, t·ªìn kho v√† s·∫£n l∆∞·ª£ng.</p></div>
                    <button type="button" onclick="resetEntryForm()" id="btnCancelEdit" class="hidden bg-white border border-gray-200 text-gray-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-gray-50 shadow-sm"><i class="fa-solid fa-xmark mr-1"></i>H·ªßy S·ª≠a</button>
                </div>

                <div id="editBanner" class="hidden edit-mode-banner">
                    <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center"><i class="fa-solid fa-pen"></i></div><div><h4 class="font-bold text-sm text-orange-800">Ch·∫ø ƒë·ªô Ch·ªânh S·ª≠a</h4><p class="text-xs text-orange-600">ƒêang c·∫≠p nh·∫≠t b√°o c√°o c≈©.</p></div></div>
                    <input type="hidden" id="editReportId">
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-4 gap-6 items-start">
    
                    <div class="xl:col-span-1 bg-white p-5 rounded-2xl shadow-sm border border-slate-200 h-full">
                        <div class="flex items-center gap-2 mb-4 pb-2 border-b border-gray-100"><span class="text-lg text-slate-400 font-black">A.</span><h3 class="text-sm font-black text-slate-700 uppercase">Th√¥ng Tin C∆° B·∫£n</h3></div>
                        <div class="space-y-3">
                            <div><label class="form-label">Th√°ng B√°o C√°o</label><input type="month" id="report_month" required class="form-input font-bold bg-slate-50"></div>
                            
                            <div class="p-3 bg-blue-50/50 border border-blue-100 rounded-lg space-y-3">
                                <div>
                                    <label class="form-label text-blue-700">1. T·ªânh / Th√†nh Ph·ªë</label>
                                    <select id="f_province" class="form-input font-bold text-slate-700 bg-white" onchange="updateSVNOptions()"><option value="">-- Ch·ªçn T·ªânh --</option></select>
                                </div>
                                <div>
                                    <label class="form-label text-blue-700">2. M√£ SVN (L·ªçc ph·ª•)</label>
                                    <select id="f_svn" class="form-input font-bold text-slate-700 bg-white" onchange="updateDVNOptions()" disabled><option value="">-- T·∫•t c·∫£ SVN --</option></select>
                                </div>
                                <div>
                                    <label class="form-label text-blue-700">3. C·ª≠a H√†ng (M√£ DVN)</label>
                                    <select id="shop_code" required class="form-input font-bold text-blue-800 bg-white" disabled><option value="">-- Ch·ªçn Shop --</option></select>
                                </div>
                            </div>
                            
                            <div id="shop_info_display" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg"></div>

                            <div class="mt-4 pt-4 border-t border-gray-100">
                                <label class="form-label text-purple-600">T·ªìn ƒê·∫ßu K·ª≥ (Khai b√°o)</label>
                                <input type="text" id="opening_stock" class="form-input font-bold text-purple-700 bg-purple-50" placeholder="0" oninput="formatCurrency(this)">
                            </div>

                            <div class="p-4 bg-orange-50 border border-orange-100 rounded-xl mt-4">
                                 <div class="text-center"><label class="form-label text-orange-700 mb-1">T·ªîNG XE B√ÅN (S.O)</label><input type="text" id="sold_quantity" readonly class="w-full bg-transparent text-center text-3xl font-black text-orange-600 outline-none" placeholder="0"></div>
                            </div>
                            <div class="space-y-3 pt-4 border-t border-gray-100">
                                 <div><label class="form-label text-blue-600">Doanh Thu (T·ª´ Xe B√°n)</label><input type="text" id="actual_revenue" readonly class="form-input text-blue-700 font-bold bg-blue-50 cursor-not-allowed" placeholder="0"></div>
                                 <div><label class="form-label text-red-600">Gi√° V·ªën (T·ª´ Xe B√°n)</label><input type="text" id="cost_goods" readonly class="form-input text-red-700 font-bold bg-red-50 cursor-not-allowed" placeholder="0"></div>
                            </div>
                        </div>
                    </div>

                    <div class="xl:col-span-3 bg-white p-6 rounded-2xl shadow-sm border border-orange-200 h-full relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-orange-500"></div>
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                            <div><h3 class="text-lg font-black text-slate-800 uppercase flex items-center gap-2"><i class="fa-solid fa-list-ol text-orange-600"></i> B·∫£ng Nh·∫≠p (S.I) & Xu·∫•t (S.O)</h3><p class="text-xs text-gray-500">Chi ti·∫øt theo t·ª´ng d√≤ng xe.</p></div>
                            <button type="button" onclick="loadMonthlyModels()" class="w-full md:w-auto bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition"><i class="fa-solid fa-cloud-download mr-2"></i> T·∫£i B·∫£ng Gi√° Admin</button>
                        </div>
                        <div class="overflow-x-auto bg-slate-50 rounded-xl border border-gray-200 min-h-[300px]">
                             <table class="w-full text-left text-sm whitespace-nowrap" id="salesDetailTable">
                                <thead class="bg-slate-100 text-[10px] font-black text-gray-500 uppercase">
                                    <tr>
                                        <th class="p-3 align-middle min-w-[150px]">Model Xe</th>
                                        <th class="p-3 w-20 text-center align-middle bg-orange-50 text-orange-600 border-l border-orange-100">S.I (Nh·∫≠p)</th>
                                        <th class="p-3 w-20 text-center align-middle bg-blue-50 text-blue-600 border-l border-blue-100">S.O (B√°n)</th>
                                        <th class="p-3 text-right align-middle min-w-[100px]">Gi√° V·ªën</th>
                                        <th class="p-3 text-right align-middle min-w-[100px]">Gi√° B√°n</th>
                                        <th class="p-3 text-right align-middle bg-orange-50/50 min-w-[100px]">Ti·ªÅn Nh·∫≠p</th>
                                        <th class="p-3 text-right align-middle bg-blue-50/50 min-w-[100px]">Ti·ªÅn B√°n</th>
                                        <th class="p-3 text-center align-middle">X√≥a</th>
                                    </tr>
                                </thead>
                                <tbody id="salesDetailBody" class="divide-y divide-gray-200"></tbody>
                                <tfoot class="bg-gray-100 font-bold text-slate-700 text-xs">
                                    <tr><td colspan="8" class="p-2 text-center"><button type="button" onclick="addSaleRow()" class="text-orange-600 hover:text-orange-800 font-black uppercase py-2 flex items-center justify-center gap-1 w-full"><i class="fa-solid fa-plus-circle"></i> Th√™m d√≤ng xe</button></td></tr>
                                    <tr class="bg-slate-800 text-white border-t border-slate-600">
                                        <td colspan="5" class="p-3 text-right uppercase">T·ªïng c·ªông:</td>
                                        <td class="p-3 text-right text-orange-300 font-mono" id="total_cal_import_val">0</td>
                                        <td class="p-3 text-right text-blue-300 font-mono" id="total_cal_rev">0</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="mt-8 flex justify-end"><button type="button" onclick="switchView('costs')" class="w-full md:w-auto bg-[#111827] text-white px-8 py-4 rounded-xl font-bold text-sm shadow-xl hover:bg-slate-800 transition flex items-center justify-center gap-2">Ti·∫øp T·ª•c: Nh·∫≠p Chi Ph√≠ <i class="fa-solid fa-arrow-right"></i></button></div>
                    </div>
                </div>
            </div>

            <div id="view-costs" class="hidden p-4 md:p-8 fade-in max-w-[1600px] mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div><h1 class="text-xl md:text-2xl font-black text-slate-800 uppercase">2. B√°o C√°o Chi Ph√≠</h1><p class="text-gray-500 text-xs mt-1">B∆∞·ªõc 2: Nh·∫≠p c√°c kho·∫£n chi ph√≠ v·∫≠n h√†nh.</p></div>
                    <button type="button" onclick="switchView('sales')" class="text-gray-500 font-bold text-xs hover:text-slate-800"><i class="fa-solid fa-arrow-left mr-1"></i> Quay l·∫°i B∆∞·ªõc 1</button>
                </div>
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-xl mb-6 flex flex-wrap gap-6 items-center shadow-sm">
                    <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white"><i class="fa-solid fa-shop"></i></div><div><p class="text-[10px] uppercase font-bold text-blue-400">ƒêang b√°o c√°o cho</p><h4 id="summary_shop_name" class="font-black text-slate-700">---</h4></div></div>
                    <div class="hidden md:block w-px h-10 bg-blue-200"></div>
                    <div><p class="text-[10px] uppercase font-bold text-blue-400">Doanh Thu (S.O)</p><h4 id="summary_rev" class="font-black text-blue-600 text-lg">0</h4></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-20">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                        <div class="flex items-center gap-2 mb-4 pb-2 border-b border-gray-100"><i class="fa-solid fa-gear text-gray-400"></i><h3 class="text-sm font-black text-slate-700 uppercase">I. V·∫≠n H√†nh & NS</h3></div>
                        <div class="space-y-3">
                            <div><label class="form-label">Kh·∫•u hao x√¢y d·ª±ng</label><input type="text" id="cost_op_depreciation_build" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label">Kh·∫•u hao thi·∫øt b·ªã</label><input type="text" id="cost_op_depreciation_equip" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label">Thu√™ m·∫∑t b·∫±ng</label><input type="text" id="cost_op_rent" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label">L∆∞∆°ng c·ª©ng (C·ªë ƒë·ªãnh)</label><input type="text" id="cost_op_salary" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label">ƒêi·ªán / N∆∞·ªõc / Net</label><input type="text" id="cost_op_utility" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label">B·∫£o tr√¨ c·ª≠a h√†ng</label><input type="text" id="cost_op_maintain" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-red-500">L√£i vay</label><input type="text" id="cost_op_interest" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div class="pt-2 border-t border-dashed"><label class="form-label text-purple-600">Hoa h·ªìng Sale</label><input type="text" id="cost_log_commission" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-purple-600">Th∆∞·ªüng KPI</label><input type="text" id="cost_log_kpi_bonus" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-purple-600">Chi·∫øt kh·∫•u</label><input type="text" id="cost_log_discount" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-green-600">H·ªó tr·ª£ H√£ng (Thu nh·∫≠p kh√°c)</label><input type="text" id="revenue_support" class="form-input text-green-700 font-bold" placeholder="0" oninput="formatCurrency(this)"></div>
                        </div>
                    </div>
                
                    <div class="bg-blue-50/50 p-5 rounded-2xl shadow-sm border border-blue-100">
                        <div class="flex items-center gap-2 mb-4 pb-2 border-b border-blue-200"><i class="fa-solid fa-truck text-blue-500"></i><h3 class="text-sm font-black text-blue-700 uppercase">II. Logistic & Xe</h3></div>
                        <div class="space-y-3">
                            <div><label class="form-label text-blue-600">V·∫≠n chuy·ªÉn xe</label><input type="text" id="cost_log_shipping" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-blue-600">Ki·ªÉm tra / L·∫Øp r√°p (PDI)</label><input type="text" id="cost_log_pdi" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-blue-600">B·∫£o h√†nh / B·∫£o tr√¨ xe</label><input type="text" id="cost_log_warranty" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-blue-600">Nh√¢n c√¥ng kho</label><input type="text" id="cost_log_warehouse_labor" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-blue-600">Tr∆∞ng b√†y / B·∫£o qu·∫£n</label><input type="text" id="cost_log_display_storage" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-blue-600">H·ªó tr·ª£ Bi·ªÉn s·ªë</label><input type="text" id="cost_log_plate_support" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-blue-600">Ph√≠ b·∫£o d∆∞·ª°ng Free</label><input type="text" id="cost_log_maintenance_free" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-blue-600">CSKH (SMS/Call)</label><input type="text" id="cost_log_cskh" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                        </div>
                    </div>
                    <div class="bg-orange-50/50 p-5 rounded-2xl shadow-sm border border-orange-100">
                        <div class="flex items-center gap-2 mb-4 pb-2 border-b border-orange-200"><i class="fa-solid fa-bullhorn text-orange-500"></i><h3 class="text-sm font-black text-orange-700 uppercase">III. Marketing</h3></div>
                        <div class="space-y-3">
                            <div><label class="form-label text-orange-600">Ads Online (FB/TikTok)</label><input type="text" id="cost_op_ads_social" class="form-input bg-white" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-orange-600">T·ªù r∆°i / Banner</label><input type="text" id="cost_op_offline_print" class="form-input bg-white" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-orange-600">Khuy·∫øn m√£i / Qu√† t·∫∑ng</label><input type="text" id="cost_op_promotion_gift" class="form-input bg-white" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-orange-600">S·ª± ki·ªán t·∫°i Shop</label><input type="text" id="cost_op_event_store" class="form-input bg-white" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div class="pt-2 border-t border-orange-200 border-dashed"></div>
                            <div><label class="form-label text-orange-600">Livestream</label><input type="text" id="cost_mkt_livestream" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-orange-600">KOL / KOC</label><input type="text" id="cost_mkt_kol_koc" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-orange-600">Qu·∫£ng c√°o chung</label><input type="text" id="cost_mkt_pr_branding" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-orange-600">Roadshow</label><input type="text" id="cost_mkt_roadshow" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-orange-600">L√°i th·ª≠ xe</label><input type="text" id="cost_mkt_testdrive" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-orange-600">Tr∆∞·ªùng h·ªçc</label><input type="text" id="cost_mkt_school" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-orange-600">B√°n h√†ng l∆∞u ƒë·ªông</label><input type="text" id="cost_mkt_mobile_sales" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-orange-600">Qu·∫£ng tr∆∞·ªùng</label><input type="text" id="cost_mkt_square" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-orange-600">Khai tr∆∞∆°ng</label><input type="text" id="cost_mkt_opening" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                            <div><label class="form-label text-orange-600">Kh√°c</label><input type="text" id="cost_mkt_other" class="form-input" placeholder="0" oninput="formatCurrency(this)"></div>
                        </div>
                    </div>
                    <div class="flex flex-col h-full bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                        <div class="flex items-center gap-2 mb-4 pb-2 border-b border-gray-100"><i class="fa-solid fa-box-open text-gray-400"></i><h3 class="text-sm font-black text-slate-700 uppercase">IV. Kh√°c</h3></div>
                        <div class="space-y-4 flex-1"><div><label class="form-label">Chi ph√≠ Kh√°c</label><input type="text" id="cost_other_general" class="form-input p-4 text-base bg-gray-50" placeholder="0" oninput="formatCurrency(this)"></div></div>
                        <div class="mt-8 pt-6 border-t border-gray-100">
                            <button type="submit" id="btnSubmit" class="w-full py-4 bg-[#FF4500] text-white font-black rounded-xl hover:bg-orange-600 transition-all transform hover:-translate-y-1 shadow-xl text-sm uppercase tracking-widest flex flex-col items-center justify-center gap-1"><i id="btnSubmitIcon" class="fa-solid fa-paper-plane text-xl"></i><span id="btnSubmitText">G·ª¨I B√ÅO C√ÅO</span></button>
                            <p id="formMsg" class="mt-4 text-center font-bold text-xs uppercase tracking-wide"></p>
                        </div>
                    </div>
                </div>
            </div>
        </form> 

        <div id="view-history" class="hidden p-4 md:p-8 fade-in max-w-[1600px] mx-auto">
            <div class="flex justify-between items-center mb-6">
                <div><h2 class="text-xl md:text-2xl font-black text-slate-800 uppercase">Qu·∫£n L√Ω B√°o C√°o</h2><p class="text-gray-500 text-xs mt-1">L·ªãch s·ª≠ g·ª≠i b√°o c√°o c·ªßa b·∫°n.</p></div>
                <button onclick="loadSaleHistory()" class="bg-white border border-gray-200 px-4 py-2 rounded-lg shadow-sm font-bold text-xs text-slate-600 hover:bg-gray-50"><i class="fa-solid fa-rotate mr-2"></i>L√†m m·ªõi</button>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="bg-slate-50 text-[10px] font-bold text-gray-500 uppercase border-b border-gray-100"><tr><th class="p-4">Th√°ng</th><th class="p-4">Khu V·ª±c</th><th class="p-4">Shop</th><th class="p-4">S·∫£n L∆∞·ª£ng</th><th class="p-4 text-right">Doanh Thu</th><th class="p-4 text-center">Tr·∫°ng Th√°i</th><th class="p-4 text-center">H√†nh ƒê·ªông</th></tr></thead>
                        <tbody id="historyBody" class="divide-y divide-gray-50 text-slate-700 font-medium"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-charts" class="hidden p-4 md:p-8 fade-in max-w-[1600px] mx-auto space-y-8">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200 mb-6 flex flex-wrap gap-4 items-end">
                 <div class="flex-1 min-w-[200px]"><label class="block text-[10px] font-bold text-blue-600 uppercase mb-1">Sale Ph·ª• Tr√°ch</label><select id="chart_sale" class="bg-blue-50/50 border border-blue-100 text-blue-700 font-bold rounded-lg p-2 text-sm w-full" onchange="updateChartFilters('sale')"><option value="">-- T·∫•t c·∫£ --</option></select></div>
                 <div class="flex-1 min-w-[150px]"><label class="block text-[10px] font-bold text-purple-600 uppercase mb-1">M√£ SVN</label><select id="chart_svn" class="bg-purple-50 border border-purple-200 text-purple-800 font-bold rounded-lg p-2 text-sm w-full" onchange="updateChartFilters('svn')"><option value="">-- T·∫•t c·∫£ --</option></select></div>
                 <div class="flex-1 min-w-[250px]"><label class="block text-[10px] font-bold text-purple-500 uppercase mb-1">C·ª≠a H√†ng (DVN)</label><select id="chart_dvn" class="bg-purple-50/50 border border-purple-100 text-purple-700 font-bold rounded-lg p-2 text-sm w-full" onchange="loadCharts()"><option value="">-- Ch·ªçn Shop --</option></select></div>
                 <button onclick="loadCharts()" class="w-full md:w-auto bg-slate-900 hover:bg-orange-600 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg transition flex items-center justify-center gap-2 text-sm uppercase"><i class="fa-solid fa-rotate"></i> C·∫≠p Nh·∫≠t</button>
            </div>
            
            <div id="chart_kpi_cards" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>

            <div id="shop-charts-container" class="space-y-6 hidden">
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200"><h4 class="text-sm font-black text-slate-800 uppercase mb-6 border-b pb-4">üí∞ S·ª©c Kh·ªèe T√†i Ch√≠nh (Waterfall)</h4><div class="h-[350px] w-full"><canvas id="chartWaterfall"></canvas></div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200"><div class="flex justify-between items-center mb-6 border-b pb-4"><h4 class="text-sm font-black text-slate-800 uppercase">üìà Ph√¢n T√≠ch ƒêi·ªÉm H√≤a V·ªën</h4><div class="text-right"><span class="block text-[10px] text-gray-400 uppercase font-bold">ƒêi·ªÉm h√≤a v·ªën d·ª± ki·∫øn</span><span id="txt_breakeven" class="text-xl font-black text-orange-600">--- xe</span></div></div><div class="h-[350px] w-full"><canvas id="chartBreakeven"></canvas></div></div>
                 </div>
                 
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200"><h4 class="text-xs font-bold text-gray-500 uppercase mb-4">C2. C∆° C·∫•u Chi Ph√≠ Shop</h4><div class="h-[250px]"><canvas id="chart_C2_Donut"></canvas></div></div>
                    <div class="lg:col-span-2 bg-white p-5 rounded-2xl shadow-sm border border-gray-200"><h4 class="text-xs font-bold text-gray-500 uppercase mb-4">C3. Xu H∆∞·ªõng Shop (12 Th√°ng)</h4><div class="h-[250px]"><canvas id="chart_C3_Trend"></canvas></div></div>
                 </div>

                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                     <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200"><div class="flex justify-between items-center mb-4"><h4 class="text-xs font-bold text-gray-500 uppercase">C5. Top Model B√°n Ch·∫°y (Theo SL)</h4></div><div class="overflow-y-auto h-[300px]" id="div_C5_Model"></div></div>
                     <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200"><h4 class="text-xs font-bold text-gray-500 uppercase mb-4">C6. Nh·∫≠p (S.I) vs B√°n (S.O) Theo Model</h4><div class="h-[300px]"><canvas id="chart_C6_Stack"></canvas></div></div>
                 </div>
            </div>
            
            <div id="regional-charts-container" class="hidden space-y-8">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                     <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200"><h4 class="text-xs font-bold text-gray-500 uppercase mb-4">X·∫øp H·∫°ng Shop Trong V√πng</h4><div class="h-[300px]"><canvas id="chart_Reg_Rank"></canvas></div></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200"><h4 class="text-xs font-bold text-gray-500 uppercase mb-4">Hi·ªáu Qu·∫£ Marketing</h4><div class="h-[300px]"><canvas id="chart_Reg_Mkt"></canvas></div></div>
                 </div>
            </div>
        </div>
    </main>
  </div>

  <script>
    Chart.register(ChartDataLabels, window['chartjs-plugin-annotation']);
    const fmn = n => new Intl.NumberFormat('vi-VN').format(Math.round(n));
    window.formatCurrency = (input) => { let val = input.value.replace(/\D/g, ""); if (val === "") { input.value = ""; return; } input.value = new Intl.NumberFormat('vi-VN').format(parseInt(val)); if(input.closest('tr')) calcRow(input); }
    const parseNumber = (val) => { if(!val) return 0; if(typeof val === 'number') return val; return parseInt(val.replace(/\./g, "").replace(/,/g, "")) || 0; }
    
    // SAFE PARSER HELPER
    const safeVal = (v) => { if(typeof v === 'number') return v; if(typeof v === 'string') return parseInt(v.replace(/[\.,]/g, '')) || 0; return 0; };
    function calcKPI(r) { const rev = safeVal(r.actual_revenue) + safeVal(r.revenue_support); const cogs = safeVal(r.cost_goods);
    const op = safeVal(r.cost_op_depreciation_build) + safeVal(r.cost_op_depreciation_equip) + safeVal(r.cost_op_rent) + safeVal(r.cost_op_salary) + safeVal(r.cost_op_utility) + safeVal(r.cost_op_maintain) + safeVal(r.cost_op_interest);
    const log = safeVal(r.cost_log_shipping) + safeVal(r.cost_log_pdi) + safeVal(r.cost_log_warranty) + safeVal(r.cost_log_warehouse_labor) + safeVal(r.cost_log_display_storage) + safeVal(r.cost_log_plate_support) + safeVal(r.cost_log_maintenance_free) + safeVal(r.cost_log_cskh) + safeVal(r.cost_log_commission) + safeVal(r.cost_log_kpi_bonus) + safeVal(r.cost_log_discount);
    const mkt = safeVal(r.cost_op_ads_social) + safeVal(r.cost_op_offline_print) + safeVal(r.cost_op_promotion_gift) + safeVal(r.cost_op_event_store) + safeVal(r.cost_mkt_livestream) + safeVal(r.cost_mkt_kol_koc) + safeVal(r.cost_mkt_pr_branding) + safeVal(r.cost_mkt_roadshow) + safeVal(r.cost_mkt_testdrive) + safeVal(r.cost_mkt_school) + safeVal(r.cost_mkt_mobile_sales) + safeVal(r.cost_mkt_square) + safeVal(r.cost_mkt_opening) + safeVal(r.cost_mkt_other);
    const other = safeVal(r.cost_other_general); const totalExp = op + log + mkt + other + cogs;
    const net = rev - totalExp; return { rev, cogs, op, log, mkt, other, totalExp, net };
    }

    // --- CONFIG ---
    const SUPABASE_URL = "https://esbukwnoaimkapinaevt.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzYnVrd25vYWlta2FwaW5hZXZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMDUzMTMsImV4cCI6MjA4Mzc4MTMxM30.QrRHVA6q-dz114CjkK64FP2ANLSwNnu6IaKC3dlBCWg";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const $ = id => document.getElementById(id);
    
    let globalShopMap = {}; 
    let globalAssignedShops = [];
    let currentAdminPrices = []; 
    let currentUser = null; 
    let assignedShopCodes = []; 
    let fullChartInstances = {};

    // --- MOBILE SIDEBAR TOGGLE ---
    function toggleSidebar() {
        const sb = document.getElementById('sidebarMobile');
        if (sb.classList.contains('-translate-x-full')) {
            sb.classList.remove('-translate-x-full');
        } else {
            sb.classList.add('-translate-x-full');
        }
    }

    // --- NAV ---
    window.switchView = (view) => {
        ['view-sales', 'view-costs', 'view-history', 'view-charts'].forEach(v => $(v).classList.add('hidden'));
        ['nav-sales', 'nav-costs', 'nav-history', 'nav-charts'].forEach(n => $(n).classList.remove('active'));
        $(`view-${view}`).classList.remove('hidden'); $(`nav-${view}`).classList.add('active');
        
        // Auto-close sidebar on mobile when item clicked
        if(window.innerWidth < 768) {
            toggleSidebar();
        }

        if(view === 'costs') {
            const shopSel = $('shop_code');
            const shopName = shopSel.options[shopSel.selectedIndex]?.text || "Ch∆∞a ch·ªçn Shop";
            $('summary_shop_name').innerText = shopName; $('summary_rev').innerText = $('actual_revenue').value + " VNƒê";
        }
        if(view === 'history') loadSaleHistory();
        if(view === 'charts') { initChartFilter(); loadCharts(); }
    }

    // --- AUTH ---
    $('goSignup').onclick = (e) => { e.preventDefault(); toggleAuth('signup'); };
    $('goLogin').onclick = (e) => { e.preventDefault(); toggleAuth('login'); };
    function toggleAuth(mode) {
        if(mode === 'signup') { $('loginFormSection').classList.add('hidden'); $('signupFormSection').classList.remove('hidden'); }
        else { $('signupFormSection').classList.add('hidden'); $('loginFormSection').classList.remove('hidden'); }
        $('msg').innerText = "";
    }
    $('btnLogin').onclick = async () => {
        const email = $('email').value, password = $('password').value;
        if(!email || !password) return showMsg("Nh·∫≠p ƒë·ªß th√¥ng tin", "red");
        showMsg("ƒêang x·ª≠ l√Ω...", "blue");
        const { error } = await sb.auth.signInWithPassword({ email, password }); if(error) showMsg(error.message, "red"); else location.reload();
    };
    $('btnSignup').onclick = async () => {
        const email = $('reg_email').value, password = $('reg_pass').value, role = $('reg_role').value, name = $('reg_name').value;
        if(!email || !password || !name) return showMsg("Thi·∫øu th√¥ng tin", "red");
        showMsg("ƒêang ƒëƒÉng k√Ω...", "blue");
        const { error } = await sb.auth.signUp({ email, password, options: { data: { role, full_name: name } } });
        if(error) showMsg(error.message, "red"); else { showMsg("Th√†nh c√¥ng! Ch·ªù duy·ªát.", "green"); setTimeout(() => location.reload(), 2000); }
    };
    function showMsg(txt, color) { $('msg').className = `text-center text-xs font-bold mt-4 h-5 text-${color}-500`; $('msg').innerText = txt; }
    
    const btnLogout = document.getElementById('btnLogout');
    if (btnLogout) {
        btnLogout.addEventListener('click', async () => {
            const { error } = await sb.auth.signOut();
            if (error) console.error("Logout Error:", error);
            else location.reload();
        });
    }

    // --- INIT ---
    async function init() {
        const { data: { session } } = await sb.auth.getSession();
        if (!session) { $('authContainer').classList.remove('hidden'); $('mainApp').classList.remove('flex'); $('mainApp').classList.add('hidden'); return; }
        
        const { data: profile } = await sb.from('profiles').select('*').eq('id', session.user.id).single();
        if (!profile || !profile.is_approved) { 
            if(!profile) setTimeout(init, 500);
            else { showMsg("T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c duy·ªát!", "red"); await sb.auth.signOut(); $('authContainer').classList.remove('hidden'); }
            return;
        }
        
        currentUser = profile;
        $('authContainer').classList.add('hidden');
        $('mainApp').classList.remove('hidden'); $('mainApp').classList.add('flex');
        $('userDisplay').innerText = profile.full_name || "Nh√¢n vi√™n"; $('roleDisplay').innerText = profile.role || "SALE"; $('avatarLetter').innerText = (profile.full_name || "U").charAt(0).toUpperCase();

        await loadShopsAndLock(profile);
    }

    // --- SMART SHOP ASSIGNMENT ---
    async function loadShopsAndLock(profile) {
        const { data: allShops } = await sb.from('master_shop_list').select('*');
        if(!allShops) return;
        allShops.forEach(s => globalShopMap[s.shop_code] = s);

        let myShops = [];
        const myName = profile.full_name ? profile.full_name.trim().toLowerCase() : "";
        if(profile.role === 'Admin') { myShops = allShops; } 
        else if (profile.role === 'Gi√°m ƒê·ªëc') { myShops = allShops.filter(s => s.director_name && s.director_name.trim().toLowerCase() === myName); } 
        else { myShops = allShops.filter(s => s.sale_name && s.sale_name.trim().toLowerCase() === myName); }

        assignedShopCodes = myShops.map(s => s.shop_code);
        globalAssignedShops = myShops;

        const provinces = [...new Set(myShops.map(s => s.province).filter(n => n))].sort();
        $('f_province').innerHTML = `<option value="">-- Ch·ªçn T·ªânh (${provinces.length}) --</option>` + provinces.map(p => `<option value="${p}">${p}</option>`).join('');
        if (myShops.length === 1) {
            const s = myShops[0];
            $('f_province').value = s.province;
            updateSVNOptions(); 
            $('f_svn').value = s.svn_code;
            updateDVNOptions();
            $('shop_code').value = s.shop_code;
            updateShopInfo();
            $('f_province').disabled = true; $('f_svn').disabled = true; $('shop_code').disabled = true;
        }
    }

    window.updateSVNOptions = () => {
        const selProv = $('f_province').value;
        const svnSelect = $('f_svn');
        const shopSelect = $('shop_code');
        
        svnSelect.innerHTML = '<option value="">-- T·∫•t c·∫£ SVN --</option>';
        shopSelect.innerHTML = '<option value="">-- Ch·ªçn Shop --</option>';
        svnSelect.disabled = true; shopSelect.disabled = true;
        $('shop_info_display').classList.add('hidden');
        if(selProv) {
            const relevantShops = globalAssignedShops.filter(s => s.province === selProv);
            const svns = [...new Set(relevantShops.map(s => s.svn_code).filter(n => n))].sort();
            svnSelect.innerHTML = `<option value="">-- T·∫•t c·∫£ SVN (${svns.length}) --</option>` + svns.map(s => `<option value="${s}">${s}</option>`).join('');
            svnSelect.disabled = false;
            shopSelect.innerHTML = `<option value="">-- Ch·ªçn Shop (${relevantShops.length}) --</option>` + 
                relevantShops.map(s => `<option value="${s.shop_code}" data-name="${s.shop_name}">${s.shop_code} - ${s.shop_name}</option>`).join('');
            shopSelect.disabled = false;
        }
    }

    window.updateDVNOptions = () => {
        const selProv = $('f_province').value;
        const selSVN = $('f_svn').value;
        const shopSelect = $('shop_code');
        
        if(selProv) {
             let relevantShops = globalAssignedShops.filter(s => s.province === selProv);
             if(selSVN) relevantShops = relevantShops.filter(s => s.svn_code === selSVN);
             
             shopSelect.innerHTML = `<option value="">-- Ch·ªçn Shop (${relevantShops.length}) --</option>` + 
                relevantShops.map(s => `<option value="${s.shop_code}" data-name="${s.shop_name}">${s.shop_code} - ${s.shop_name}</option>`).join('');
             shopSelect.disabled = false;
        }
    }

    $('shop_code').onchange = updateShopInfo;
    function updateShopInfo() {
        const opt = $('shop_code').options[$('shop_code').selectedIndex];
        if(!opt || !opt.value) { $('shop_info_display').classList.add('hidden'); return; }
        const shopData = globalShopMap[opt.value];
        if(shopData) {
            $('shop_info_display').classList.remove('hidden');
            $('shop_info_display').innerHTML = `<div class="font-black text-sm uppercase text-green-800">${shopData.shop_name}</div><div class="text-[10px] text-green-600 font-bold mt-1">Gi√°m ƒê·ªëc: ${shopData.director_name || '---'}</div>`;
        }
    }

    // --- SALES DETAILS ---
    async function loadMonthlyModels() {
        const month = $('report_month').value;
        if(!month) { alert("Vui l√≤ng ch·ªçn Th√°ng B√°o C√°o tr∆∞·ªõc!"); return; }
        const { data, error } = await sb.from('monthly_product_prices').select('*').eq('report_month', month);
        if(error || !data || data.length === 0) { alert(`Ch∆∞a c√≥ b·∫£ng gi√° Admin th√°ng ${month}!`); currentAdminPrices = []; }
        else { currentAdminPrices = data; if($('salesDetailBody').children.length === 0) addSaleRow(); alert(`ƒê√£ t·∫£i ${data.length} model.`); }
        renderModelOptionsAll();
    }
    function getModelOptionsHtml(selectedModel = "") {
        if(!currentAdminPrices.length) return `<option value="">-- B·∫•m T·∫£i B·∫£ng Gi√° --</option>`;
        return `<option value="">-- Ch·ªçn xe --</option>` + currentAdminPrices.map(p => { const isSel = p.model === selectedModel ? 'selected' : ''; return `<option value="${p.model}" data-si="${p.import_price}" data-so="${p.selling_price}" ${isSel}>${p.model}</option>`; }).join('');
    }
    function renderModelOptionsAll() { document.querySelectorAll('.model-select').forEach(sel => { const curr = sel.value; sel.innerHTML = getModelOptionsHtml(curr); }); }
    
    window.addSaleRow = (data = {}) => {
        const tr = document.createElement('tr');
        tr.className = "bg-white border-b border-gray-100 hover:bg-gray-50 transition";
        tr.innerHTML = `<td class="p-2"><select class="model-select w-full bg-white border border-gray-200 rounded p-1.5 text-xs font-bold outline-none focus:border-orange-500" onchange="onModelChange(this)">${getModelOptionsHtml(data.model)}</select></td><td class="p-2 border-l border-orange-100"><input type="text" class="qty-si-input w-full text-center border border-orange-200 rounded p-1.5 text-xs font-bold text-orange-700 bg-orange-50" value="${data.qty_si || 0}" oninput="formatCurrency(this)"></td><td class="p-2 border-l border-blue-100"><input type="text" class="qty-so-input w-full text-center border border-blue-200 rounded p-1.5 text-xs font-bold text-blue-700 bg-blue-50" value="${data.qty_so || 0}" oninput="formatCurrency(this)"></td><td class="p-2"><input type="text" class="si-input w-full text-right text-gray-400 bg-transparent border-none text-xs" value="${fmn(data.si || 0)}" readonly></td><td class="p-2"><input type="text" class="so-input w-full text-right border border-gray-200 text-gray-700 rounded p-1.5 text-xs font-bold" value="${fmn(data.so || 0)}" oninput="formatCurrency(this)"></td><td class="p-2 text-right font-bold text-orange-600 bg-orange-50/50 text-xs total-si-row border-l border-orange-100">0</td><td class="p-2 text-right font-bold text-blue-600 bg-blue-50/50 text-xs total-so-row border-l border-blue-100">0</td><td class="p-2 text-center"><button type="button" onclick="this.closest('tr').remove(); calcAll();" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td>`;
        $('salesDetailBody').appendChild(tr); if(data.model) calcRow(tr.querySelector('input')); 
    };
    window.onModelChange = (selectEl) => { const opt = selectEl.options[selectEl.selectedIndex]; const row = selectEl.closest('tr'); if(opt.value) { row.querySelector('.si-input').value = fmn(opt.getAttribute('data-si')); const soInput = row.querySelector('.so-input'); if(parseNumber(soInput.value) == 0) soInput.value = fmn(opt.getAttribute('data-so')); } calcRow(selectEl); };
    window.calcRow = (el) => { const row = el.closest('tr'); const qtySI = parseNumber(row.querySelector('.qty-si-input').value); const qtySO = parseNumber(row.querySelector('.qty-so-input').value); const so = parseNumber(row.querySelector('.so-input').value); const si = parseNumber(row.querySelector('.si-input').value); row.querySelector('.si-input').value = fmn(si); row.querySelector('.total-si-row').innerText = fmn(qtySI * si);
    row.querySelector('.total-so-row').innerText = fmn(qtySO * so); calcAll(); };
    window.calcAll = () => { let totalRev = 0, totalImportVal = 0, totalSoldQty = 0;
    let totalCOGS_Real = 0; document.querySelectorAll('#salesDetailBody tr').forEach(tr => { const qtySI = parseNumber(tr.querySelector('.qty-si-input').value); const qtySO = parseNumber(tr.querySelector('.qty-so-input').value); const so = parseNumber(tr.querySelector('.so-input').value); const si = parseNumber(tr.querySelector('.si-input').value); totalImportVal += (qtySI * si); totalRev += (qtySO * so); totalCOGS_Real += (qtySO * si); totalSoldQty += qtySO; });
    if($('total_cal_import_val')) $('total_cal_import_val').innerText = fmn(totalImportVal); if($('total_cal_rev')) $('total_cal_rev').innerText = fmn(totalRev); $('actual_revenue').value = fmn(totalRev); $('cost_goods').value = fmn(totalCOGS_Real); $('sold_quantity').value = fmn(totalSoldQty); };
    
    // --- HISTORY TAB ---
    async function loadSaleHistory() {
        if(assignedShopCodes.length === 0) return;
        const { data: reports } = await sb.from('financial_reports').select('*').in('shop_code', assignedShopCodes).order('created_at', { ascending: false });
        $('historyBody').innerHTML = (reports||[]).map(r => {
            const isPending = r.status === 'submitted';
            const statusBadge = isPending ? `<span class="bg-orange-100 text-orange-600 px-2 py-1 rounded text-[10px] font-bold">CH·ªú DUY·ªÜT</span>` : `<span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-[10px] font-bold">ƒê√É DUY·ªÜT</span>`;
            const actions = isPending 
                ? `<button onclick="editReport('${r.report_id}')" class="text-blue-500 hover:bg-blue-100 p-2 rounded mx-1" title="S·ª≠a"><i class="fa-solid fa-pen-to-square text-lg"></i></button>
                   <button onclick="deleteReport('${r.report_id}')" class="text-red-500 hover:bg-red-100 p-2 rounded mx-1" title="X√≥a"><i class="fa-solid fa-trash text-lg"></i></button>`
                : `<span class="text-gray-300 p-2"><i class="fa-solid fa-lock"></i></span>`;
            const shopInfo = globalShopMap[r.shop_code] || {};
            return `<tr class="hover:bg-gray-50 transition border-b"><td class="p-4 font-bold text-xs">${r.report_month}</td><td class="p-4 text-xs font-bold text-purple-600">${shopInfo.area || "---"}</td><td class="p-4 text-xs text-gray-500">${r.shop_code}</td><td class="p-4 text-xs font-bold text-slate-800 uppercase">${shopInfo.shop_name || "---"}</td><td class="p-4 text-xs font-black text-orange-600 text-center">${r.sold_quantity || 0}</td><td class="p-4 text-right font-mono font-bold text-blue-600 text-xs">${fmn(r.actual_revenue)}</td><td class="p-4 text-center">${statusBadge}</td><td class="p-4 text-center whitespace-nowrap">${actions}</td></tr>`;
        }).join('');
    }

    // --- CHART FILTER CHAIN LOGIC ---
    function initChartFilter() {
        if (!currentUser) return;
        const sales = [...new Set(globalAssignedShops.map(s => s.sale_name).filter(n => n))].sort();
        $('chart_sale').innerHTML = `<option value="">-- T·∫•t c·∫£ Sale --</option>` + sales.map(s => `<option value="${s}">${s}</option>`).join('');
        if(currentUser.role !== 'Gi√°m ƒê·ªëc' && currentUser.role !== 'Admin') {
            $('chart_sale').value = currentUser.full_name;
            $('chart_sale').disabled = true; 
        }
        updateChartFilters('sale');
    }

    window.updateChartFilters = (level) => {
        const selSale = $('chart_sale').value;
        const selSVN = $('chart_svn').value;
        let filtered = globalAssignedShops;

        if (selSale) filtered = filtered.filter(s => s.sale_name === selSale);
        if (level === 'sale') {
            const svns = [...new Set(filtered.map(s => s.svn_code).filter(n => n))].sort();
            $('chart_svn').innerHTML = `<option value="">-- T·∫•t c·∫£ SVN --</option>` + svns.map(s => `<option value="${s}">${s}</option>`).join('');
            $('chart_svn').value = "";
        }

        if ($('chart_svn').value) filtered = filtered.filter(s => s.svn_code === $('chart_svn').value);
        const dvns = filtered.sort((a,b) => a.shop_code.localeCompare(b.shop_code));
        $('chart_dvn').innerHTML = `<option value="">-- Ch·ªçn Shop ƒë·ªÉ xem chi ti·∫øt --</option>` + dvns.map(s => `<option value="${s.shop_code}">${s.shop_code} - ${s.shop_name}</option>`).join('');
        if(dvns.length === 1) { $('chart_dvn').value = dvns[0].shop_code; loadCharts(); }
    }

    // --- CHART RENDER LOGIC ---
    async function loadCharts() {
        const selDVN = $('chart_dvn').value;
        if (!selDVN) { alert("Vui l√≤ng ch·ªçn 1 C·ª≠a H√†ng (DVN) ƒë·ªÉ xem chi ti·∫øt!"); return; }

        const { data: reports } = await sb.from('financial_reports').select('*')
            .eq('shop_code', selDVN)
            .eq('status', 'approved')
            .order('report_month', {ascending: true});

        if(!reports || reports.length === 0) { 
            $('shop-charts-container').classList.add('hidden');
            alert("Shop n√†y ch∆∞a c√≥ b√°o c√°o n√†o ƒë∆∞·ª£c duy·ªát!"); 
            return; 
        }

        $('shop-charts-container').classList.remove('hidden');
        const latestReport = reports[reports.length - 1];
        renderShopLevel(latestReport, reports);
    }
    
    function renderChart(type, id, data, options={}) { const ctx = $(id).getContext('2d');
    if(fullChartInstances[id]) fullChartInstances[id].destroy(); fullChartInstances[id] = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'bottom', labels:{boxWidth:10, font:{size:10}}}, datalabels: { color: '#fff', font:{weight:'bold', size:9}, formatter: (v) => type==='pie'||type==='doughnut'||type==='bar'? (v>0?fmn(v):'') : '', display: type==='pie'||type==='doughnut' }, tooltip: { callbacks: { label: c => ` ${c.dataset.label}: ${fmn(c.raw.y||c.raw)}` } }, ...options.plugins }, scales: options.scales || {}, ...options } });
    }
    
    function renderShopLevel(r, allReports) {
        const k = calcKPI(r);
        let totalSI = 0; let details = [];
        try{details = typeof r.sales_detail_json==='string'?JSON.parse(r.sales_detail_json):r.sales_detail_json||[];}catch(e){}
        if(details.length) { details.forEach(d => totalSI += (d.qty_si || 0)); }
        const openStock = safeVal(r.opening_stock); const totalSO = r.sold_quantity || 0;
        const endStock = openStock + totalSI - totalSO;
        
        $('chart_kpi_cards').innerHTML = `<div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-blue-500 text-center"><p class="text-[10px] font-black uppercase">S.I (Nh·∫≠p)</p><h4 class="text-3xl font-black text-blue-600">${totalSI}</h4></div><div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-green-500 text-center"><p class="text-[10px] font-black uppercase">S.O (B√°n)</p><h4 class="text-3xl font-black text-green-600">${totalSO}</h4></div><div class="bg-white p-4 rounded-xl shadow-sm border-b-4 ${endStock<0?'border-red-500':'border-purple-500'} text-center"><p class="text-[10px] font-black uppercase">T·ªìn Cu·ªëi</p><h4 class="text-3xl font-black ${endStock<0?'text-red-600':'text-purple-600'}">${endStock}</h4></div>`;
        renderChart('bar', 'chartWaterfall', { labels: ['Doanh Thu', 'Gi√° V·ªën', 'V·∫≠n H√†nh', 'Logistic', 'Marketing', 'Kh√°c', 'L·ª¢I NHU·∫¨N'], datasets: [{ data: [k.rev, -k.cogs, -k.op, -k.log, -k.mkt, -k.other, k.net], backgroundColor: ['#3b82f6', '#ef4444', '#ef4444', '#ef4444', '#ef4444', '#ef4444', k.net>=0?'#16a34a':'#b91c1c'] }] }, {plugins:{legend:{display:false}}});
        if(totalSO > 0) { const fixed = k.op + k.mkt + k.other;
        const varUnit = (k.cogs + k.log) / totalSO; const asp = k.rev / totalSO; const contrib = asp - varUnit;
        const bep = contrib>0 ? Math.ceil(fixed/contrib) : 0; $('txt_breakeven').innerText = bep>0 ? `~${bep} xe` : "L·ªó g·ªôp";
        const maxQ = Math.max(totalSO*1.5, bep*1.5, 20); const pts=[], dRev=[], dCost=[]; for(let i=0; i<=maxQ; i+=Math.ceil(maxQ/10)) { pts.push(i); dRev.push(i*asp); dCost.push(fixed + i*varUnit);
        } renderChart('line', 'chartBreakeven', {labels:pts, datasets:[{label:'Doanh Thu', data:dRev, borderColor:'#16a34a'}, {label:'T·ªïng Chi Ph√≠', data:dCost, borderColor:'#ef4444'}]}, {plugins:{annotation:{annotations:{pt:{type:'point', xValue:bep, yValue:bep*asp, backgroundColor:'orange', radius:6}}}}});
        }

        renderChart('doughnut', 'chart_C2_Donut', { labels:['V·∫≠n h√†nh','Logistic','MKT','Kh√°c'], datasets:[{data:[k.op, k.log, k.mkt, k.other], backgroundColor:['#64748b','#3b82f6','#f97316','#a8a29e']}] });
        const trendLabels = allReports.map(x => x.report_month);
        const trendRev = allReports.map(x => calcKPI(x).rev);
        const trendNet = allReports.map(x => calcKPI(x).net);
        renderChart('line', 'chart_C3_Trend', { labels: trendLabels, datasets:[ {label:'Doanh Thu', data:trendRev, borderColor:'#2563eb', tension:0.3}, {label:'L·ª£i Nhu·∫≠n', data:trendNet, borderColor:'#16a34a', tension:0.3} ] });
        if(details.length) {
            details.sort((a,b)=>(b.qty_so||0)-(a.qty_so||0));
            $('div_C5_Model').innerHTML = `<table class="w-full text-xs text-left" id="table_C5_Model"><thead class="bg-gray-100 font-bold sticky top-0"><tr><th class="p-2">Model</th><th class="p-2 text-center">SL B√°n</th><th class="p-2 text-right">Doanh Thu</th></tr></thead><tbody>${details.map(d => `<tr class="border-b"><td class="p-2">${d.model}</td><td class="p-2 text-center font-bold">${d.qty_so||0}</td><td class="p-2 text-right font-mono">${fmn((d.qty_so||0)*(d.so||0))}</td></tr>`).join('')}</tbody></table>`;
            renderChart('bar', 'chart_C6_Stack', { labels: details.map(d=>d.model), datasets: [ {label:'B√°n (S.O)', data:details.map(d=>d.qty_so||0), backgroundColor:'#3b82f6'}, {label:'Nh·∫≠p (S.I)', data:details.map(d=>d.qty_si||0), backgroundColor:'#f97316'} ] }, {scales:{x:{stacked:true}, y:{stacked:true}}});
        } else {
             $('div_C5_Model').innerHTML = "<p class='p-4 text-center text-gray-400'>Kh√¥ng c√≥ d·ªØ li·ªáu model</p>";
             if(fullChartInstances['chart_C6_Stack']) fullChartInstances['chart_C6_Stack'].destroy();
        }
    }

    // --- FORM ACTIONS ---
    $('financeForm').onsubmit = async (e) => {
        e.preventDefault();
        $('btnSubmit').disabled = true; $('formMsg').innerText = "ƒêang x·ª≠ l√Ω...";
        const val = id => parseNumber($(id).value);
        const detailRows = [];
        document.querySelectorAll('#salesDetailBody tr').forEach(tr => { detailRows.push({ model: tr.querySelector('.model-select').value, qty_si: parseNumber(tr.querySelector('.qty-si-input').value), qty_so: parseNumber(tr.querySelector('.qty-so-input').value), si: parseNumber(tr.querySelector('.si-input').value), so: parseNumber(tr.querySelector('.so-input').value) }); });
        const payload = { report_month: $('report_month').value + "-01", shop_code: $('shop_code').value, opening_stock: val('opening_stock'), sold_quantity: val('sold_quantity'), sales_detail_json: detailRows, actual_revenue: val('actual_revenue'), revenue_support: val('revenue_support'), cost_goods: val('cost_goods'), cost_op_depreciation_build: val('cost_op_depreciation_build'), cost_op_depreciation_equip: val('cost_op_depreciation_equip'), cost_op_rent: val('cost_op_rent'), cost_op_salary: val('cost_op_salary'), cost_op_utility: val('cost_op_utility'), cost_op_maintain: val('cost_op_maintain'), cost_op_interest: val('cost_op_interest'), cost_log_commission: val('cost_log_commission'), cost_log_kpi_bonus: val('cost_log_kpi_bonus'), cost_log_discount: val('cost_log_discount'), cost_log_shipping: val('cost_log_shipping'), cost_log_pdi: val('cost_log_pdi'), cost_log_warranty: val('cost_log_warranty'), cost_log_warehouse_labor: val('cost_log_warehouse_labor'), cost_log_display_storage: val('cost_log_display_storage'), cost_log_plate_support: val('cost_log_plate_support'), cost_log_maintenance_free: val('cost_log_maintenance_free'), cost_log_cskh: val('cost_log_cskh'), cost_op_ads_social: val('cost_op_ads_social'), cost_op_offline_print: val('cost_op_offline_print'), cost_op_promotion_gift: val('cost_op_promotion_gift'), cost_op_event_store: val('cost_op_event_store'), cost_mkt_livestream: val('cost_mkt_livestream'), cost_mkt_kol_koc: val('cost_mkt_kol_koc'), cost_mkt_pr_branding: val('cost_mkt_pr_branding'), cost_mkt_roadshow: val('cost_mkt_roadshow'), cost_mkt_testdrive: val('cost_mkt_testdrive'), cost_mkt_school: val('cost_mkt_school'), cost_mkt_mobile_sales: val('cost_mkt_mobile_sales'), cost_mkt_square: val('cost_mkt_square'), cost_mkt_opening: val('cost_mkt_opening'), cost_mkt_other: val('cost_mkt_other'), cost_other_general: val('cost_other_general'), status: 'submitted' };
        const editId = $('editReportId').value;
        let res = editId ? await sb.from('financial_reports').update(payload).eq('report_id', editId) : await sb.from('financial_reports').insert([payload]);
        if(res.error) { $('formMsg').innerText = "L·ªói: " + res.error.message; $('formMsg').className = "mt-4 text-center font-bold text-xs text-red-500"; $('btnSubmit').disabled = false;
        }
        else { $('formMsg').innerText = "Th√†nh c√¥ng!";
        $('formMsg').className = "mt-4 text-center font-bold text-xs text-green-500"; resetEntryForm(); setTimeout(() => { $('btnSubmit').disabled = false; $('formMsg').innerText = ""; switchView('history'); }, 1500);
        }
    };

    window.editReport = async (id) => {
        const { data: r } = await sb.from('financial_reports').select('*').eq('report_id', id).single();
        if(!r) return;
        switchView('sales'); $('editReportId').value = r.report_id; $('editBanner').classList.remove('hidden'); $('btnCancelEdit').classList.remove('hidden'); $('entryTitle').innerText = "C·∫≠p Nh·∫≠t B√°o C√°o"; $('btnSubmitText').innerText = "L∆∞u Thay ƒê·ªïi";
        $('btnSubmit').className = "w-full py-4 bg-orange-600 text-white font-black rounded-xl hover:bg-orange-700 shadow-xl text-sm uppercase flex flex-col items-center justify-center gap-1";
        const shop = globalShopMap[r.shop_code];
        if (shop) {
            $('f_province').value = shop.province; updateSVNOptions();
            $('f_svn').value = shop.svn_code; updateDVNOptions();
            $('shop_code').value = r.shop_code; updateShopInfo();
        }
        if(r.report_month) $('report_month').value = r.report_month.slice(0, 7);
        const setVal = (key, val) => { if($(key)) $(key).value = fmn(val || 0); };
        setVal('opening_stock', r.opening_stock); 
        setVal('sold_quantity', r.sold_quantity); setVal('actual_revenue', r.actual_revenue);
        setVal('cost_goods', r.cost_goods); setVal('revenue_support', r.revenue_support);
        setVal('cost_op_depreciation_build', r.cost_op_depreciation_build); setVal('cost_op_depreciation_equip', r.cost_op_depreciation_equip); setVal('cost_op_rent', r.cost_op_rent); setVal('cost_op_salary', r.cost_op_salary); setVal('cost_op_utility', r.cost_op_utility); setVal('cost_op_maintain', r.cost_op_maintain); setVal('cost_op_interest', r.cost_op_interest);
        setVal('cost_log_commission', r.cost_log_commission);
        setVal('cost_log_kpi_bonus', r.cost_log_kpi_bonus); setVal('cost_log_discount', r.cost_log_discount); setVal('cost_log_shipping', r.cost_log_shipping); setVal('cost_log_pdi', r.cost_log_pdi); setVal('cost_log_warranty', r.cost_log_warranty); setVal('cost_log_warehouse_labor', r.cost_log_warehouse_labor); setVal('cost_log_display_storage', r.cost_log_display_storage); setVal('cost_log_plate_support', r.cost_log_plate_support); setVal('cost_log_maintenance_free', r.cost_log_maintenance_free); setVal('cost_log_cskh', r.cost_log_cskh);
        setVal('cost_op_ads_social', r.cost_op_ads_social); setVal('cost_op_offline_print', r.cost_op_offline_print); setVal('cost_op_promotion_gift', r.cost_op_promotion_gift); setVal('cost_op_event_store', r.cost_op_event_store); setVal('cost_mkt_livestream', r.cost_mkt_livestream); setVal('cost_mkt_kol_koc', r.cost_mkt_kol_koc); setVal('cost_mkt_pr_branding', r.cost_mkt_pr_branding); setVal('cost_mkt_roadshow', r.cost_mkt_roadshow); setVal('cost_mkt_testdrive', r.cost_mkt_testdrive); setVal('cost_mkt_school', r.cost_mkt_school);
        setVal('cost_mkt_mobile_sales', r.cost_mkt_mobile_sales); setVal('cost_mkt_square', r.cost_mkt_square); setVal('cost_mkt_opening', r.cost_mkt_opening); setVal('cost_mkt_other', r.cost_mkt_other); setVal('cost_other_general', r.cost_other_general);
        await loadMonthlyModels();
        $('salesDetailBody').innerHTML = "";
        let details = [];
        try{details = typeof r.sales_detail_json === 'string' ? JSON.parse(r.sales_detail_json) : r.sales_detail_json || [];}catch(e){}
        if(details.length) { details.forEach(item => addSaleRow(item)); }
    }

    window.deleteReport = async (id) => { if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√°o c√°o n√†y kh√¥ng?")) { await sb.from('financial_reports').delete().eq('report_id', id);
    loadSaleHistory(); } }
    window.resetEntryForm = () => { $('financeForm').reset(); $('salesDetailBody').innerHTML = ""; currentAdminPrices = [];
    $('editReportId').value = ""; $('editBanner').classList.add('hidden'); $('btnCancelEdit').classList.add('hidden'); $('entryTitle').innerText = "1. B√°o C√°o Nh·∫≠p - Xu·∫•t"; $('btnSubmitText').innerText = "G·ª¨I B√ÅO C√ÅO";
    $('btnSubmit').className = "w-full py-4 bg-[#FF4500] text-white font-black rounded-xl hover:bg-orange-600 transition-all shadow-xl text-sm uppercase flex flex-col items-center justify-center gap-1";
    const now = new Date(); $('report_month').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; 
    $('f_province').value = ""; updateSVNOptions();
    }

    const now = new Date(); $('report_month').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    init();
  </script>
</body>
</html>
